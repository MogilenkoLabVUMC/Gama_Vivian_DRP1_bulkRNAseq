# General Quality Control Plots

**Location:** `03_Results/02_Analysis/Plots/General/`
**Generated by:** `02_Analysis/1.1.main_pipeline.R`
**Last Updated:** 2025-12-04

---

## Overview

This directory contains quality control (QC) visualizations that assess sample quality, replicate consistency, and overall data structure before differential expression analysis.

---

## File Inventory

| File | Size | Description |
|------|------|-------------|
| `sample_correlation_heatmap_ordered.pdf` | 10 KB | Sample-sample correlation matrix |
| `MDS_plot.pdf` | 6 KB | Multi-dimensional scaling plot |
| `PCA_plot.pdf` | 6 KB | Principal component analysis plot |
| `DE_gene_counts.pdf` | 5 KB | DEG counts by contrast |
| `UpSet_plot_all_contrasts.pdf` | 8 KB | Overlap of significant genes |

---

## Plot Descriptions

### Sample Correlation Heatmap

**File:** `sample_correlation_heatmap_ordered.pdf`

**What it shows:**
- Pearson correlation of log-CPM expression between all sample pairs
- Samples ordered by timepoint (D35 → D65) then genotype (Control → G32A → R403C)
- Annotation bars showing genotype and timepoint

**Color scheme:**
- Yellow/Brown scale: Higher = more similar (r closer to 1)
- Annotation: Genotype (green=Control, orange=G32A, purple=R403C)
- Annotation: Days (pink=D35, green=D65)

**Expected patterns:**
- High correlation within replicates (r > 0.95)
- Higher correlation within genotype than between
- Visible timepoint clustering

**Quality checks:**
- ✓ No outlier samples (low correlation with group)
- ✓ Replicates cluster together
- ✓ Expected biological groupings visible

### MDS Plot

**File:** `MDS_plot.pdf`

**What it shows:**
- Multi-dimensional scaling of sample distances based on leading log-fold-changes
- Each point = one sample
- Colors = genotype (Control=teal, G32A=orange, R403C=purple)
- Shapes = timepoint (circle=D35, triangle=D65)

**Interpretation:**
- X-axis (Leading logFC dim 1, 32%): Primary source of variation
- Y-axis (Leading logFC dim 2, 15%): Secondary source of variation
- Samples that cluster = similar expression profiles

**Expected patterns:**
- Samples group by genotype and/or timepoint
- Replicates cluster tightly
- Mutations separate from controls

### PCA Plot

**File:** `PCA_plot.pdf`

**What it shows:**
- Principal component analysis of scaled log-CPM expression values
- Each point = one sample
- Colors = genotype (Control=teal, G32A=orange, R403C=purple)
- Shapes = timepoint (circle=D35, triangle=D65)

**Interpretation:**
- X-axis (PC1, 35.1%): Primary source of variation (timepoint)
- Y-axis (PC2, 15.3%): Secondary source of variation
- Complements MDS with different distance metric

**Expected patterns:**
- Clear separation between D35 and D65 samples
- Genotypes show some clustering within timepoints

### DE Gene Counts

**File:** `DE_gene_counts.pdf`

**What it shows:**
- Bar chart of differentially expressed gene counts
- Each contrast on x-axis
- Bars split by direction (Up/Down)
- Count labels on each bar

**Color coding:**
- Orange: Upregulated genes
- Blue: Downregulated genes

**Typical counts:**
| Contrast Type | Expected DEGs |
|---------------|---------------|
| Mutation vs Ctrl | 500 - 3,000 |
| Time effects | 2,000 - 8,000 |
| Interaction | 100 - 1,000 |

### UpSet Plot

**File:** `UpSet_plot_all_contrasts.pdf`

**What it shows:**
- Intersection sizes between contrast gene lists
- More interpretable alternative to Venn diagram
- Horizontal bars: Total genes per contrast
- Vertical bars: Intersection sizes
- Connected dots: Which contrasts share genes

**Interpretation:**
- Largest vertical bars = most shared gene signatures
- Isolated dots = contrast-specific genes
- Connected patterns = which contrasts co-regulate genes

---

## Generation Code

All plots generated in `02_Analysis/1.1.main_pipeline.R` (lines 247-319, 464-490).

```r
# Sample correlation heatmap (lines 247-254)
pdf(file.path(qc_dir, "sample_correlation_heatmap_ordered.pdf"), 12, 10)
pheatmap(ordered_cor,
         annotation_row  = annot, annotation_col = annot,
         annotation_colors = ann_colors,
         color = get_correlation_palette(100),
         cluster_rows = FALSE, cluster_cols = FALSE,
         border_color = NA)
dev.off()

# MDS plot - ggplot2 style (lines 256-287)
mds <- plotMDS(v, plot = FALSE)
mds_df <- data.frame(Dim1 = mds$x, Dim2 = mds$y,
                     Genotype = annot$genotype, Timepoint = annot$days)
mds_var <- round(mds$var.explained[1:2] * 100, 0)

mds_plot <- ggplot(mds_df, aes(x = Dim1, y = Dim2, color = Genotype, shape = Timepoint)) +
  geom_point(size = 4, stroke = 1) +
  scale_color_manual(values = ann_colors$genotype) +
  scale_shape_manual(values = c(D35 = 16, D65 = 17)) +
  labs(x = sprintf("Leading logFC dim 1 (%s%%)", mds_var[1]),
       y = sprintf("Leading logFC dim 2 (%s%%)", mds_var[2])) +
  theme_minimal(base_size = 14) +
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(color = "grey70", fill = NA, linewidth = 0.5),
        legend.position = "right",
        legend.background = element_rect(color = "grey80", fill = "white", linewidth = 0.3),
        axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold")) +
  coord_fixed()
pdf(file.path(qc_dir, "MDS_plot.pdf"), 8, 6)
print(mds_plot)
dev.off()

# PCA plot - ggplot2 style (lines 289-319)
pca_res <- prcomp(t(logCPM), scale. = TRUE)
pct_var <- round(100 * pca_res$sdev^2 / sum(pca_res$sdev^2), 1)
pca_df <- data.frame(PC1 = pca_res$x[,1], PC2 = pca_res$x[,2],
                     Genotype = annot$genotype, Timepoint = annot$days)

pca_plot <- ggplot(pca_df, aes(x = PC1, y = PC2, color = Genotype, shape = Timepoint)) +
  geom_point(size = 4, stroke = 1) +
  scale_color_manual(values = ann_colors$genotype) +
  scale_shape_manual(values = c(D35 = 16, D65 = 17)) +
  labs(x = sprintf("PC1 (%s%% variance)", pct_var[1]),
       y = sprintf("PC2 (%s%% variance)", pct_var[2])) +
  theme_minimal(base_size = 14) +
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(color = "grey70", fill = NA, linewidth = 0.5),
        legend.position = "right",
        legend.background = element_rect(color = "grey80", fill = "white", linewidth = 0.3),
        axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold")) +
  coord_fixed()
pdf(file.path(qc_dir, "PCA_plot.pdf"), 8, 6)
print(pca_plot)
dev.off()

# DE gene counts (lines 464-477)
pdf(file.path(qc_dir, "DE_gene_counts.pdf"), 10, 6, onefile = TRUE)
print(ggplot(deg_long, aes(Contrast, Count, fill = Direction)) +
  geom_col(position = position_dodge(width = .8), width = .7) +
  geom_text(aes(label = Count), vjust = -.2,
            position = position_dodge(width = .8), size = 3) +
  scale_fill_manual(values = c(Up = "#D55E00", Down = "#0072B2")) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_blank()) +
  labs(y = "gene count", x = NULL, fill = ""))
dev.off()

# UpSet plot (lines 487-491)
upset_plot <- upset(fromList(sig_genes_list), order.by = "freq", nsets = length(sig_genes_list))
pdf(file.path(qc_dir, "UpSet_plot_all_contrasts.pdf"), width = 12, height = 8)
print(upset_plot)
dev.off()
```

---

## Quality Control Checklist

### Sample Quality

- [ ] All samples have high correlation with replicates (r > 0.9)
- [ ] No sample is an outlier in MDS plot
- [ ] Expected batch/group structure visible

### Differential Expression

- [ ] Reasonable DEG counts (not 0, not all genes)
- [ ] Up and down genes balanced (unless biology dictates otherwise)
- [ ] Time effects show more DEGs than interactions

### Biological Consistency

- [ ] Mutations cluster separately from controls
- [ ] Timepoints show expected separation
- [ ] Replicate variation smaller than biological variation

---

## Sample Information

### Sample Order (as used in heatmap)

```
D35_Control_1, D35_Control_2, D35_Control_3,
D35_G32A_1, D35_G32A_2, D35_G32A_3,
D35_R403C_1, D35_R403C_2, D35_R403C_3,
D65_Control_1, D65_Control_2, D65_Control_3,
D65_G32A_1, D65_G32A_2, D65_G32A_3,
D65_R403C_1, D65_R403C_2, D65_R403C_3
```

### Color Palette

```r
ann_colors <- list(
  genotype = c(Control = "#1B9E77", G32A = "#D95F02", R403C = "#7570B3"),
  days     = c(D35 = "#E7298A", D65 = "#66A61E")
)
```

---

## Related Documentation

- `../README.md` - Overall Plots directory
- `../../README.md` - Main analysis overview
- `../../checkpoints/README.md` - Source QC data (qc_variables.rds)
