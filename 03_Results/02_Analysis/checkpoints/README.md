# Analysis Checkpoints

**Location:** `03_Results/02_Analysis/checkpoints/`
**Generated by:** `02_Analysis/1a.Main_pipeline.R` and related scripts
**Last Updated:** 2025-11-25

---

## Overview

This folder contains cached R objects (RDS files) that store intermediate and final results from expensive computations. The checkpoint system enables:

1. **Reproducibility:** Exact replication of analysis results
2. **Efficiency:** Skip expensive re-computation on subsequent runs
3. **Modularity:** Downstream scripts can load pre-computed results
4. **Debugging:** Inspect intermediate objects without re-running

---

## Checkpoint Files

### Core Model Objects

| File | Size | Description | Generated By |
|------|------|-------------|--------------|
| `model_objects.rds` | 22 MB | Complete limma model (fit, voom, design) | 1a.Main_pipeline.R |
| `DGE_object.rds` | 1.3 MB | edgeR DGEList with counts and normalization | 1a.Main_pipeline.R |
| `voom_object.rds` | 5.8 MB | voom-transformed expression matrix | 1a.Main_pipeline.R |
| `fit_object.rds` | 14 MB | Fitted limma linear model | 1a.Main_pipeline.R |
| `contrasts_matrix.rds` | 281 B | Contrast definitions matrix | 1a.Main_pipeline.R |

### Differential Expression Results

| File | Size | Description | Generated By |
|------|------|-------------|--------------|
| `contrast_tables.rds` | 7.9 MB | All DE tables (9 contrasts) | 1a.Main_pipeline.R |
| `de_results.rds` | 162 KB | decideTests results (up/down flags) | 1a.Main_pipeline.R |

### GSEA Results

| File | Size | Description | Generated By |
|------|------|-------------|--------------|
| `all_gsea_results.rds` | 82 MB | MSigDB GSEA (all databases, all contrasts) | 1a.Main_pipeline.R |
| `syngo_gsea_results.rds` | 2.4 MB | SynGO GSEA results | 1a.Main_pipeline.R |
| `syngo_lists.rds` | 13 KB | SynGO TERM2GENE and TERM2NAME | 1a.Main_pipeline.R |
| `mitocarta_gsea_results.rds` | 2.4 MB | MitoCarta GSEA results | 2.add_MitoCarta.R |

### Quality Control & Annotation

| File | Size | Description | Generated By |
|------|------|-------------|--------------|
| `qc_variables.rds` | 2.1 MB | Sample annotations, colors, ordered samples | 1a.Main_pipeline.R |
| `gene_intersections.rds` | 207 B | Shared DE genes between mutations | 1a.Main_pipeline.R |

### Module Analysis

| File | Size | Description | Generated By |
|------|------|-------------|--------------|
| `gsva_module_scores.rds` | 4.6 KB | GSVA pathway scores per sample | viz_critical_period_trajectories_gsva.R |

---

## Object Structures

### model_objects.rds

```r
model_objs <- readRDS("model_objects.rds")
# List with:
#   $fit        - MArrayLM object (contrasts.fit + eBayes)
#   $v          - EList from voom (log-CPM + weights)
#   $de_results - decideTests matrix
#   $DGE        - DGEList with normalized counts
#   $contrasts  - Contrast matrix
```

### contrast_tables.rds

```r
contrast_tables <- readRDS("contrast_tables.rds")
# Named list of data.frames:
#   $G32A_vs_Ctrl_D35   - data.frame with logFC, t, P.Value, adj.P.Val, B
#   $G32A_vs_Ctrl_D65
#   $R403C_vs_Ctrl_D35
#   $R403C_vs_Ctrl_D65
#   $Time_Ctrl
#   $Time_G32A
#   $Time_R403C
#   $Maturation_G32A_specific
#   $Maturation_R403C_specific
```

### all_gsea_results.rds

```r
gsea_results <- readRDS("all_gsea_results.rds")
# Nested named list:
#   $G32A_vs_Ctrl_D35
#     $hallmark   - gseaResult object
#     $kegg       - gseaResult object
#     $reactome   - gseaResult object
#     $gobp       - gseaResult object
#     $gocc       - gseaResult object
#     $gomf       - gseaResult object
#     $wiki       - gseaResult object
#     $canon      - gseaResult object
#     $cgp        - gseaResult object
#     $tf         - gseaResult object
#   ... (9 contrasts x 10 databases)

# Access example:
hallmark_d35 <- gsea_results$G32A_vs_Ctrl_D35$hallmark
head(hallmark_d35@result)
```

### syngo_gsea_results.rds

```r
syngo_results <- readRDS("syngo_gsea_results.rds")
# Named list by contrast:
#   $G32A_vs_Ctrl_D35  - gseaResult for SynGO CC
#   $R403C_vs_Ctrl_D35
#   ... (9 contrasts)
```

### qc_variables.rds

```r
qc_vars <- readRDS("qc_variables.rds")
# List with:
#   $ordered_samples  - Character vector of sample names (ordered)
#   $annot           - Data frame with genotype and days columns
#   $ann_colors      - Named list of color palettes
#   $logCPM          - Log-CPM expression matrix
```

---

## Checkpoint System

### How It Works

The main pipeline uses a `load_or_compute()` helper function:

```r
load_or_compute <- function(checkpoint_file, compute_fn,
                            force_recompute = FALSE,
                            description = "computation") {
  if (!force_recompute && file.exists(checkpoint_file)) {
    message("Loading cached ", description)
    return(readRDS(checkpoint_file))
  }
  result <- compute_fn()
  saveRDS(result, checkpoint_file)
  return(result)
}
```

### Forcing Recomputation

**Option 1:** Set config flag

```r
# In 02_Analysis/1a.Main_pipeline.R
config <- list(
  ...
  force_recompute = TRUE  # Set to TRUE to ignore caches
)
```

**Option 2:** Delete specific checkpoint

```bash
rm checkpoints/all_gsea_results.rds
Rscript 02_Analysis/1a.Main_pipeline.R
```

**Option 3:** Delete all checkpoints

```bash
rm checkpoints/*.rds
Rscript 02_Analysis/1a.Main_pipeline.R
```

---

## When to Delete Checkpoints

Delete checkpoints when:

| Scenario | Action |
|----------|--------|
| Changed input data | Delete all checkpoints |
| Modified normalization | Delete all checkpoints |
| Changed contrast definitions | Delete `model_objects.rds`, `contrast_tables.rds` |
| Updated GSEA parameters | Delete `*_gsea_results.rds` |
| Added new database | Delete `all_gsea_results.rds` |
| Debugging unexpected results | Delete relevant checkpoint |

---

## Usage Examples

### Load contrast tables for custom analysis

```r
contrast_tables <- readRDS("03_Results/02_Analysis/checkpoints/contrast_tables.rds")

# Access specific contrast
g32a_d35 <- contrast_tables$G32A_vs_Ctrl_D35

# Significant genes
sig_genes <- g32a_d35[g32a_d35$adj.P.Val < 0.05, ]
```

### Extract GSEA results

```r
all_gsea <- readRDS("03_Results/02_Analysis/checkpoints/all_gsea_results.rds")

# Get Hallmark results for one contrast
hallmark <- all_gsea$G32A_vs_Ctrl_D35$hallmark

# Convert to data.frame
hallmark_df <- as.data.frame(hallmark@result)

# Filter significant
sig_pathways <- hallmark_df[hallmark_df$p.adjust < 0.05, ]
```

### Access voom expression for custom plots

```r
qc_vars <- readRDS("03_Results/02_Analysis/checkpoints/qc_variables.rds")

# Log-CPM matrix
expr <- qc_vars$logCPM

# Sample annotations
annot <- qc_vars$annot

# Make custom heatmap
library(pheatmap)
gene_subset <- c("NNAT", "CACNG3", "STIM1")
pheatmap(expr[gene_subset, qc_vars$ordered_samples],
         annotation_col = annot)
```

---

## Dependency Graph

```
[Raw Data: counts + metadata]
         │
         ▼
  model_objects.rds ─────────────────────────────┐
         │                                        │
         ├── DGE_object.rds                      │
         ├── voom_object.rds                     │
         ├── fit_object.rds                      │
         └── contrasts_matrix.rds                │
                  │                               │
                  ▼                               │
         contrast_tables.rds                      │
                  │                               │
                  ├── de_results.rds              │
                  │                               │
                  ▼                               ▼
         all_gsea_results.rds            qc_variables.rds
                  │
                  ├── syngo_gsea_results.rds
                  │   └── syngo_lists.rds
                  │
                  └── mitocarta_gsea_results.rds
                             │
                             ▼
                  gsva_module_scores.rds
```

---

## Performance Notes

| Computation | Time (First Run) | Time (Cached) |
|-------------|------------------|---------------|
| voomLmFit + eBayes | 3-5 min | <1 sec |
| MSigDB GSEA (all) | 20-40 min | <1 sec |
| SynGO GSEA | 5-10 min | <1 sec |
| MitoCarta GSEA | 2-5 min | <1 sec |

**Total checkpoint size:** ~140 MB

---

## Troubleshooting

### "Cannot read checkpoint" error

```r
# Check file exists and is readable
file.exists("checkpoints/model_objects.rds")
file.info("checkpoints/model_objects.rds")$size

# Try loading directly
tryCatch(
  readRDS("checkpoints/model_objects.rds"),
  error = function(e) message("Error: ", e$message)
)
```

### Corrupted checkpoint

If a checkpoint file is corrupted:

```bash
# Delete and regenerate
rm checkpoints/corrupted_file.rds
Rscript 02_Analysis/1a.Main_pipeline.R
```

### Out of memory when loading

```r
# Check object size before loading
file.info("checkpoints/all_gsea_results.rds")$size / 1e6  # MB

# Load selectively
gsea <- readRDS("checkpoints/all_gsea_results.rds")
# Extract only needed contrast
g32a_only <- gsea$G32A_vs_Ctrl_D35
rm(gsea)
gc()
```

---

## Related Documentation

- `../README.md` - Main analysis overview
- `CLAUDE.md` - Pipeline configuration
- `02_Analysis/1a.Main_pipeline.R` - Checkpoint generation code
